#!/bin/bash
#
# hf-nomad - Control script for HF NomadNet/Reticulum stack
#
set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

CONFIG_FILE="$HOME/.config/hf-nomad/config"

info() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[OK]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

# Load config
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        # shellcheck source=/dev/null
        source "$CONFIG_FILE"
    else
        error "Config not found: $CONFIG_FILE\nRun 'configure.sh' first."
    fi
}

# Check if user services are installed
check_services_installed() {
    local user_dir="$HOME/.config/systemd/user"
    if [ ! -f "$user_dir/hf-nomad-modem.service" ]; then
        return 1
    fi
    return 0
}

# Install systemd user services
install_services() {
    local script_dir
    script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
    local user_dir="$HOME/.config/systemd/user"

    mkdir -p "$user_dir"

    info "Installing systemd user services..."
    cp "$script_dir/systemd/hf-nomad-rigctld.service" "$user_dir/"
    cp "$script_dir/systemd/hf-nomad-modem.service" "$user_dir/"
    cp "$script_dir/systemd/hf-nomad.target" "$user_dir/"

    systemctl --user daemon-reload
    success "Services installed"
}

# Start the HF stack
cmd_start() {
    load_config

    if ! check_services_installed; then
        install_services
    fi

    info "Starting hf-nomad stack..."

    # Start rigctld if we have CAT control
    if [ "$RADIO_SERIAL" != "none" ] && [ "$RADIO_MODEL" != "none" ]; then
        info "Starting rigctld ($RADIO_MODEL_NAME)..."
        systemctl --user start hf-nomad-rigctld.service
        sleep 1
    fi

    # Start modem
    info "Starting freedvtnc2 modem..."
    systemctl --user start hf-nomad-modem.service

    success "HF stack started"
    echo ""
    cmd_status
}

# Stop the HF stack
cmd_stop() {
    info "Stopping hf-nomad stack..."

    systemctl --user stop hf-nomad-modem.service 2>/dev/null || true
    systemctl --user stop hf-nomad-rigctld.service 2>/dev/null || true

    success "HF stack stopped"
}

# Show status
cmd_status() {
    load_config

    echo -e "${BOLD}hf-nomad Status${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    # Config summary
    echo -e "${CYAN}Configuration:${NC}"
    echo "  Radio:     $RADIO_MODEL_NAME"
    echo "  Serial:    $RADIO_SERIAL"
    echo "  PTT:       $PTT_METHOD"
    echo "  FreeDV:    $FREEDV_MODE"
    echo "  KISS Port: $KISS_PORT"
    echo ""

    # Service status
    echo -e "${CYAN}Services:${NC}"

    if [ "$RADIO_SERIAL" != "none" ]; then
        if systemctl --user is-active --quiet hf-nomad-rigctld.service 2>/dev/null; then
            echo -e "  rigctld:   ${GREEN}running${NC}"
        else
            echo -e "  rigctld:   ${RED}stopped${NC}"
        fi
    else
        echo -e "  rigctld:   ${YELLOW}disabled${NC} (no CAT)"
    fi

    if systemctl --user is-active --quiet hf-nomad-modem.service 2>/dev/null; then
        echo -e "  freedvtnc2: ${GREEN}running${NC}"
    else
        echo -e "  freedvtnc2: ${RED}stopped${NC}"
    fi

    # Check if KISS port is listening
    echo ""
    echo -e "${CYAN}Connectivity:${NC}"
    if ss -tln 2>/dev/null | grep -q ":${KISS_PORT} " || netstat -tln 2>/dev/null | grep -q ":${KISS_PORT} "; then
        echo -e "  KISS TCP:  ${GREEN}listening${NC} on port $KISS_PORT"
    else
        echo -e "  KISS TCP:  ${RED}not listening${NC}"
    fi

    if [ "$PTT_METHOD" = "rigctld" ]; then
        if ss -tln 2>/dev/null | grep -q ":${RIGCTLD_PORT} " || netstat -tln 2>/dev/null | grep -q ":${RIGCTLD_PORT} "; then
            echo -e "  rigctld:   ${GREEN}listening${NC} on port $RIGCTLD_PORT"
        else
            echo -e "  rigctld:   ${RED}not listening${NC}"
        fi
    fi
    echo ""
}

# Test radio connection
cmd_test_radio() {
    load_config

    if [ "$RADIO_SERIAL" = "none" ]; then
        warn "No radio configured (VOX mode)"
        return
    fi

    echo -e "${BOLD}Testing Radio Connection${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "Radio: $RADIO_MODEL_NAME (model $RADIO_MODEL)"
    echo "Port:  $RADIO_SERIAL"
    echo ""

    # Check if serial port exists
    if [ ! -e "$RADIO_SERIAL" ]; then
        error "Serial port not found: $RADIO_SERIAL"
    fi
    success "Serial port exists"

    # Check if we can read from it
    if [ ! -r "$RADIO_SERIAL" ]; then
        error "Cannot read from $RADIO_SERIAL (permission denied)"
    fi
    success "Serial port readable"

    # Test with rigctl
    info "Testing CAT connection with rigctl..."
    echo ""

    if rigctl -m "$RADIO_MODEL" -r "$RADIO_SERIAL" f 2>&1; then
        echo ""
        success "Radio responding to CAT commands"
    else
        echo ""
        error "Failed to communicate with radio"
    fi

    # Get more info
    echo ""
    info "Querying radio info..."
    rigctl -m "$RADIO_MODEL" -r "$RADIO_SERIAL" --dump-caps 2>/dev/null | head -20 || true
}

# Test audio devices
cmd_test_audio() {
    load_config

    echo -e "${BOLD}Testing Audio Devices${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "Input device:  $AUDIO_INPUT_DEVICE"
    echo "Output device: $AUDIO_OUTPUT_DEVICE"
    echo ""

    # Show device info
    echo -e "${CYAN}Input device info:${NC}"
    arecord -l 2>/dev/null | grep -A1 "card $AUDIO_INPUT_DEVICE" || warn "Device $AUDIO_INPUT_DEVICE not found"
    echo ""

    echo -e "${CYAN}Output device info:${NC}"
    aplay -l 2>/dev/null | grep -A1 "card $AUDIO_OUTPUT_DEVICE" || warn "Device $AUDIO_OUTPUT_DEVICE not found"
    echo ""

    # Quick recording test
    echo -e "${CYAN}Testing audio capture (2 seconds)...${NC}"
    echo "Speak into the microphone or send audio from radio..."

    local tmpfile
    tmpfile=$(mktemp --suffix=.wav)
    if timeout 2 arecord -D "hw:$AUDIO_INPUT_DEVICE,0" -f S16_LE -r 48000 -c 1 "$tmpfile" 2>/dev/null; then
        local size
        size=$(stat -c%s "$tmpfile")
        if [ "$size" -gt 10000 ]; then
            success "Audio captured ($size bytes)"
        else
            warn "Audio captured but very small ($size bytes) - check levels"
        fi
    else
        warn "Could not capture audio - device may be in use or wrong format"
    fi
    rm -f "$tmpfile"
}

# Live monitor
cmd_monitor() {
    load_config

    echo -e "${BOLD}hf-nomad Monitor${NC}"
    echo "Press Ctrl+C to exit"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    # Follow modem logs
    if systemctl --user is-active --quiet hf-nomad-modem.service 2>/dev/null; then
        journalctl --user -u hf-nomad-modem.service -f
    else
        warn "Modem service not running"
        echo "Start with: hf-nomad start"
    fi
}

# Show logs
cmd_logs() {
    local service="${1:-modem}"
    local lines="${2:-50}"

    case "$service" in
        modem|freedvtnc2)
            journalctl --user -u hf-nomad-modem.service -n "$lines"
            ;;
        rigctld|rig)
            journalctl --user -u hf-nomad-rigctld.service -n "$lines"
            ;;
        all)
            journalctl --user -u 'hf-nomad-*' -n "$lines"
            ;;
        *)
            echo "Usage: hf-nomad logs [modem|rigctld|all] [lines]"
            ;;
    esac
}

# Enable autostart
cmd_enable() {
    if ! check_services_installed; then
        install_services
    fi

    load_config

    info "Enabling autostart..."

    if [ "$RADIO_SERIAL" != "none" ]; then
        systemctl --user enable hf-nomad-rigctld.service
    fi
    systemctl --user enable hf-nomad-modem.service

    success "Autostart enabled"
    echo "Services will start automatically on login."
}

# Disable autostart
cmd_disable() {
    info "Disabling autostart..."
    systemctl --user disable hf-nomad-rigctld.service 2>/dev/null || true
    systemctl --user disable hf-nomad-modem.service 2>/dev/null || true
    success "Autostart disabled"
}

# Restart services
cmd_restart() {
    cmd_stop
    sleep 1
    cmd_start
}

# Change FreeDV mode
cmd_mode() {
    local new_mode="${1:-}"
    local config_file="$HOME/.freedvtnc2.conf"

    if [ ! -f "$config_file" ]; then
        error "Config not found: $config_file"
    fi

    local current_mode
    current_mode=$(grep -E "^mode=" "$config_file" | cut -d= -f2)

    if [ -z "$new_mode" ]; then
        # Show current mode and options
        echo -e "${BOLD}FreeDV Mode${NC}"
        echo ""
        echo -e "Current mode: ${GREEN}${current_mode}${NC}"
        echo ""
        echo "Available modes:"
        echo "  DATAC1  ~980 bps, ~1.7 kHz  (good conditions)"
        echo "  DATAC3  ~321 bps, ~0.9 kHz  (moderate conditions)"
        echo "  DATAC4   ~87 bps, ~0.5 kHz  (weak signals)"
        echo ""
        echo "Usage: hf-nomad mode <DATAC1|DATAC3|DATAC4>"
        return
    fi

    # Validate mode
    case "$new_mode" in
        DATAC1|DATAC3|DATAC4)
            ;;
        datac1|datac3|datac4)
            new_mode=$(echo "$new_mode" | tr '[:lower:]' '[:upper:]')
            ;;
        *)
            error "Invalid mode: $new_mode (use DATAC1, DATAC3, or DATAC4)"
            ;;
    esac

    if [ "$new_mode" = "$current_mode" ]; then
        info "Already using $new_mode"
        return
    fi

    # Update config
    sed -i "s/^mode=.*/mode=$new_mode/" "$config_file"
    success "Mode changed: $current_mode → $new_mode"

    # Restart if running
    if systemctl --user is-active --quiet hf-nomad-modem.service 2>/dev/null; then
        info "Restarting modem..."
        systemctl --user restart hf-nomad-modem.service
        sleep 2
        if systemctl --user is-active --quiet hf-nomad-modem.service 2>/dev/null; then
            success "Modem restarted with $new_mode"
        else
            warn "Modem failed to restart - check logs"
        fi
    else
        info "Modem not running. Start with: hf-nomad start"
    fi
}

# Show help
cmd_help() {
    echo "hf-nomad - HF NomadNet/Reticulum control script"
    echo ""
    echo "Usage: hf-nomad <command> [options]"
    echo ""
    echo "Commands:"
    echo "  start        Start the HF radio stack (rigctld + freedvtnc2)"
    echo "  stop         Stop the HF radio stack"
    echo "  restart      Restart the HF radio stack"
    echo "  status       Show current status"
    echo ""
    echo "  test-radio   Test CAT connection to radio"
    echo "  test-audio   Test audio device configuration"
    echo ""
    echo "  mode [MODE]  Show/change FreeDV mode (DATAC1|DATAC3|DATAC4)"
    echo "  monitor      Follow live modem output"
    echo "  logs [svc]   Show service logs (modem|rigctld|all)"
    echo ""
    echo "  enable       Enable autostart on login"
    echo "  disable      Disable autostart"
    echo ""
    echo "  help         Show this help"
    echo ""
    echo "After starting, run 'nomadnet' to use NomadNet over HF."
}

# Main
case "${1:-}" in
    start)
        cmd_start
        ;;
    stop)
        cmd_stop
        ;;
    restart)
        cmd_restart
        ;;
    status)
        cmd_status
        ;;
    test-radio)
        cmd_test_radio
        ;;
    test-audio)
        cmd_test_audio
        ;;
    mode)
        cmd_mode "${2:-}"
        ;;
    monitor)
        cmd_monitor
        ;;
    logs)
        cmd_logs "${2:-}" "${3:-}"
        ;;
    enable)
        cmd_enable
        ;;
    disable)
        cmd_disable
        ;;
    help|--help|-h)
        cmd_help
        ;;
    "")
        cmd_status
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'hf-nomad help' for usage."
        exit 1
        ;;
esac
